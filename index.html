<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BlockSync - Sonera HOA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Plus Jakarta Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-font-smoothing: antialiased; background-color: #fafaf9; }
        
        /* Layout Reset */
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        /* Mobile Input Fixes */
        input, select, textarea { font-size: 16px !important; } 
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }

        /* Scrollbar */
        .scroll-area::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Animations */
        .animate-enter { animation: enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Modern Input Base - STRICT SIZING */
        .modern-input {
            display: block;
            width: 100%;
            max-width: 100%; 
            min-width: 0;    
            background-color: #f5f5f4; /* stone-100 */
            border: 1px solid transparent;
            padding: 0 1rem; 
            border-radius: 1rem;
            font-weight: 600;
            color: #44403c; /* stone-700 */
            transition: all 0.2s;
            outline: none;
            box-sizing: border-box; 
            height: 3.5rem; 
            line-height: 3.5rem; 
        }
        
        /* Specific Fixes for Date Inputs */
        input[type="date"].modern-input, input[type="month"].modern-input {
            -webkit-appearance: none;
            appearance: none;
            display: block;
            padding-top: 0;
            padding-bottom: 0;
            line-height: 3.5rem;
            min-height: 3.5rem;
        }

        .modern-input:focus {
            background-color: #ffffff;
            border-color: #0d9488; /* teal-600 */
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.1);
        }
        .modern-input::placeholder { color: #a8a29e; font-weight: 500; }
        
        /* Card Style */
        .glass-card {
            background: white;
            border: 1px solid #e7e5e4; /* stone-200 */
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: { 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' },
                        orange: { 500: '#f97316' },
                        blue: { 400: '#60a5fa' }
                    }
                }
            }
        }
    </script>
</head>
<body class="text-stone-800 tap-highlight-transparent">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, deleteDoc, doc, updateDoc, setDoc, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        const SUBDIVISION_MAP = {
            "1": 67, "2": 98, "3": 57, "4": 54, "5": 43,
            "6": 13, "7": 18, "8": 18, "9": 16, "10": 2,
            "11": 30, "12": 28, "13": 26, "14": 26, "15": 9,
            "16": 18, "17": 18, "18": 18, "19": 18, "20": 42,
            "21": 42, "22": 38, "23": 34, "24": 30, "25": 10
        };

        const DEFAULT_CATEGORIES = ["Waste Collection", "Monthly Dues", "Security Fee"];

        const firebaseConfig = {
            apiKey: "AIzaSyCApFluUkql1dqrGwH5r67DO6E-L-ez-OM",
            authDomain: "blocksync-d48e5.firebaseapp.com",
            projectId: "blocksync-d48e5",
            storageBucket: "blocksync-d48e5.firebasestorage.app",
            messagingSenderId: "354921111118",
            appId: "1:354921111118:web:7b7fa1624fd0d37e402d1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- HELPERS ---
        const formatMoney = (amount) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(amount);
        const getMonthYear = (dateObj) => dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
        const formatDateDisplay = (dateObj) => dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        const toInputDate = (dateObj) => dateObj.toISOString().split('T')[0];
        const toInputMonth = (dateObj) => dateObj.toISOString().slice(0, 7);

        // --- SHARED UI COMPONENTS ---

        const Toast = ({ message, type, onClose }) => {
            React.useEffect(() => { const t = setTimeout(onClose, 2500); return () => clearTimeout(t); }, [onClose]);
            const color = type === 'error' ? 'bg-red-500' : (type === 'warning' ? 'bg-orange-500' : 'bg-stone-900');
            return (
                <div className="fixed top-24 left-0 right-0 z-[100] flex justify-center pointer-events-none px-4">
                    <div className={`${color} text-white px-6 py-4 rounded-2xl shadow-xl flex items-center space-x-3 animate-pop pointer-events-auto max-w-sm`}>
                        <i className={`fa-solid ${type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}`}></i>
                        <span className="font-semibold text-sm">{message}</span>
                    </div>
                </div>
            );
        };

        const Modal = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm flex items-center justify-center z-[60] p-6 animate-enter" onClick={onClose}>
                <div className="bg-white rounded-[2rem] w-full max-w-sm shadow-2xl overflow-hidden animate-pop" onClick={e => e.stopPropagation()}>
                    {children}
                </div>
            </div>
        );

        const PageContainer = ({ children }) => (
            <div className="max-w-lg mx-auto w-full space-y-6 pb-20 animate-enter px-4">
                {children}
            </div>
        );

        // --- FEATURE COMPONENTS ---

        const CategoryManagerModal = ({ onClose, showToast }) => {
            const [categories, setCategories] = React.useState([]);
            const [newCat, setNewCat] = React.useState("");
            const [editIdx, setEditIdx] = React.useState(-1);
            const [editVal, setEditVal] = React.useState("");

            React.useEffect(() => {
                const unsub = onSnapshot(doc(db, "config", "categories"), (snap) => {
                    if (snap.exists()) setCategories(snap.data().list || DEFAULT_CATEGORIES);
                    else setCategories(DEFAULT_CATEGORIES);
                });
                return () => unsub();
            }, []);

            const saveList = async (newList) => {
                try {
                    await setDoc(doc(db, "config", "categories"), { list: newList }, { merge: true });
                } catch (e) { showToast("Error saving categories", "error"); }
            };

            const addCat = async (e) => {
                e.preventDefault();
                if (!newCat.trim()) return;
                const updated = [...categories, newCat.trim()];
                await saveList(updated);
                setNewCat("");
                showToast("Category added", "success");
            };

            const deleteCat = async (idx) => {
                if(!confirm("Remove this category from the dropdown? Past records won't be affected.")) return;
                const updated = categories.filter((_, i) => i !== idx);
                await saveList(updated);
            };

            const startEdit = (idx) => {
                setEditIdx(idx);
                setEditVal(categories[idx]);
            };

            const saveEdit = async (idx) => {
                const updated = [...categories];
                updated[idx] = editVal.trim();
                await saveList(updated);
                setEditIdx(-1);
            };

            return (
                <Modal onClose={onClose}>
                    <div className="p-6 h-[80vh] flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg">Manage Categories</h3>
                            <button onClick={onClose}><i className="fa-solid fa-times text-stone-400 text-xl"></i></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto scroll-area space-y-3 mb-4">
                            {categories.map((cat, idx) => (
                                <div key={idx} className="flex items-center gap-2 bg-stone-50 p-3 rounded-xl border border-stone-100">
                                    {editIdx === idx ? (
                                        <>
                                            <input className="flex-1 bg-white border border-stone-200 rounded-lg px-2 py-1 outline-none" value={editVal} onChange={e=>setEditVal(e.target.value)} autoFocus />
                                            <button onClick={()=>saveEdit(idx)} className="text-teal-600 p-2"><i className="fa-solid fa-check"></i></button>
                                        </>
                                    ) : (
                                        <>
                                            <span className="flex-1 font-medium text-stone-600">{cat}</span>
                                            <button onClick={()=>startEdit(idx)} className="text-stone-400 hover:text-teal-600 p-2"><i className="fa-solid fa-pen"></i></button>
                                            <button onClick={()=>deleteCat(idx)} className="text-stone-400 hover:text-red-500 p-2"><i className="fa-solid fa-trash"></i></button>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>

                        <form onSubmit={addCat} className="pt-4 border-t border-stone-100">
                            <div className="flex gap-2">
                                <input placeholder="New Category Name" value={newCat} onChange={e=>setNewCat(e.target.value)} className="modern-input h-12" />
                                <button type="submit" className="bg-stone-900 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg"><i className="fa-solid fa-plus"></i></button>
                            </div>
                        </form>
                    </div>
                </Modal>
            );
        };

        const LoginModal = ({ onClose }) => {
            const [user, setUser] = React.useState("");
            const [pass, setPass] = React.useState("");
            const [err, setErr] = React.useState("");
            const [load, setLoad] = React.useState(false);

            const handle = async (e) => {
                e.preventDefault();
                setLoad(true); setErr("");
                const email = user.toLowerCase().trim() === "admin" ? "admin@sonera.com" : user;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    onClose();
                } catch (e) { setErr("Access Denied"); }
                setLoad(false);
            };

            return (
                <Modal onClose={onClose}>
                    <div className="p-8 text-center bg-stone-50">
                        <div className="w-14 h-14 bg-white text-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm">
                            <i className="fa-solid fa-fingerprint"></i>
                        </div>
                        <h2 className="font-bold text-xl text-stone-800">Admin Access</h2>
                    </div>
                    <form onSubmit={handle} className="p-8 pt-4 space-y-4">
                        {err && <div className="bg-red-50 text-red-500 p-3 rounded-xl text-center text-sm font-bold">{err}</div>}
                        <input className="modern-input" placeholder="Username" value={user} onChange={e=>setUser(e.target.value)} required />
                        <input className="modern-input" type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} required />
                        <div className="flex gap-3 pt-2">
                            <button type="button" onClick={onClose} className="flex-1 py-4 text-stone-400 font-bold hover:text-stone-600 transition">Cancel</button>
                            <button type="submit" disabled={load} className="flex-1 py-4 bg-teal-600 text-white rounded-2xl font-bold shadow-lg shadow-teal-200 hover:bg-teal-700 transition">{load ? '...' : 'Unlock'}</button>
                        </div>
                    </form>
                </Modal>
            );
        };

        const InitBalModal = ({ initialBalance, onSave, onClose }) => {
            const [val, setVal] = React.useState(initialBalance || "");
            return (
                <Modal>
                    <div className="p-8 text-center">
                        <div className="w-14 h-14 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                            <i className="fa-solid fa-coins"></i>
                        </div>
                        <h3 className="font-bold text-xl mb-2">Starting Fund</h3>
                        <p className="text-stone-500 text-sm leading-relaxed mb-6">
                            Please enter the <b>Total Remaining Funds</b> from before using BlockSync. This sets your baseline.
                        </p>
                        <input type="number" value={val} onChange={e=>setVal(e.target.value)} className="modern-input text-center text-2xl font-bold mb-6 h-auto" placeholder="0.00" autoFocus />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3.5 bg-stone-100 rounded-xl font-bold text-stone-500">Cancel</button>
                            <button onClick={()=>onSave(val)} className="flex-1 py-3.5 bg-teal-600 text-white rounded-xl font-bold">Save Baseline</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const EditPaymentModal = ({ payment, onClose, showToast }) => {
            const [amount, setAmount] = React.useState(payment.amount);
            const [date, setDate] = React.useState(toInputDate(payment.datePaid.toDate()));
            const [del, setDel] = React.useState(false);

            const update = async () => {
                try { await updateDoc(doc(db, "payments", payment.id), { amount: parseFloat(amount), datePaid: Timestamp.fromDate(new Date(date)) }); showToast("Updated!", "success"); onClose(); } catch(e){ showToast(e.message, "error"); }
            };
            const remove = async () => {
                try { await deleteDoc(doc(db, "payments", payment.id)); showToast("Deleted!", "success"); onClose(); } catch(e){ showToast(e.message, "error"); }
            };

            return (
                <Modal onClose={onClose}>
                    {del ? (
                        <div className="p-8 text-center">
                            <i className="fa-solid fa-trash-can text-red-500 text-4xl mb-4"></i>
                            <h3 className="font-bold text-lg mb-4">Delete this record?</h3>
                            <div className="flex gap-2">
                                <button onClick={()=>setDel(false)} className="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-500">No</button>
                                <button onClick={remove} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold">Yes, Delete</button>
                            </div>
                        </div>
                    ) : (
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg">Edit Record</h3>
                                <button onClick={onClose}><i className="fa-solid fa-times text-stone-400 text-xl"></i></button>
                            </div>
                            <div className="bg-stone-50 p-4 rounded-xl mb-4 text-sm font-medium text-stone-600 flex justify-between">
                                <span>Block {payment.block} Lot {payment.lot}</span>
                                <span className="text-teal-600">{payment.category}</span>
                            </div>
                            <div className="space-y-4">
                                <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} className="modern-input" />
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="modern-input" />
                                <div className="flex gap-2 pt-2">
                                    <button onClick={()=>setDel(true)} className="p-4 bg-red-50 text-red-500 rounded-xl"><i className="fa-solid fa-trash"></i></button>
                                    <button onClick={update} className="flex-1 bg-stone-900 text-white rounded-xl font-bold">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    )}
                </Modal>
            );
        };

        // --- MAIN VIEWS ---

        const ActiveUnitsMode = () => {
            const [block, setBlock] = React.useState("1");
            const [payments, setPayments] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            const lots = Array.from({length: SUBDIVISION_MAP[block]||20}, (_,i)=>i+1);
            const totalUnits = Object.values(SUBDIVISION_MAP).reduce((a,b) => a+b, 0);

            React.useEffect(() => {
                // Fetch ALL payments once for client-side processing
                const unsub = onSnapshot(collection(db, "payments"), (snapshot) => {
                    const data = snapshot.docs.map(doc => doc.data());
                    setPayments(data);
                    setLoading(false);
                });
                return () => unsub();
            }, []);

            // Logic to determine status
            const getUnitStatus = () => {
                const statusMap = {}; // Key: "Block-Lot", Value: "Active" | "Dormant" | "Never"
                
                // Group payments by unit
                const unitPayments = {};
                payments.forEach(p => {
                    const key = `${p.block}-${p.lot}`;
                    if (!unitPayments[key]) unitPayments[key] = [];
                    unitPayments[key].push(p.datePaid.toDate());
                });

                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                for (let b in SUBDIVISION_MAP) {
                    for (let l = 1; l <= SUBDIVISION_MAP[b]; l++) {
                        const key = `${b}-${l}`;
                        const dates = unitPayments[key];

                        if (!dates || dates.length === 0) {
                            statusMap[key] = "Never";
                        } else {
                            // Sort dates descending (newest first)
                            dates.sort((a,b) => b - a);
                            const latestDate = dates[0];
                            
                            if (latestDate >= threeMonthsAgo) {
                                statusMap[key] = "Active";
                            } else {
                                statusMap[key] = "Dormant";
                            }
                        }
                    }
                }
                return statusMap;
            };

            const statusMap = React.useMemo(() => !loading ? getUnitStatus() : {}, [payments, loading]);

            // Calculate Stats
            const stats = React.useMemo(() => {
                let active = 0, dormant = 0, never = 0;
                Object.values(statusMap).forEach(s => {
                    if (s === "Active") active++;
                    else if (s === "Dormant") dormant++;
                    else never++;
                });
                return { active, dormant, never };
            }, [statusMap]);

            const collectionRate = totalUnits > 0 ? Math.round((stats.active / totalUnits) * 100) : 0;

            return (
                <PageContainer>
                    {/* Insights Dashboard */}
                    <div className="glass-card p-6">
                        <h2 className="text-xl font-bold text-stone-800 mb-4">Analytics</h2>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-teal-50 p-4 rounded-2xl border border-teal-100">
                                <p className="text-xs font-bold text-teal-600 uppercase mb-1">Collection Rate</p>
                                <p className="text-2xl font-extrabold text-teal-800">{collectionRate}%</p>
                            </div>
                            <div className="bg-stone-50 p-4 rounded-2xl border border-stone-100">
                                <p className="text-xs font-bold text-stone-500 uppercase mb-1">Total Units</p>
                                <p className="text-2xl font-extrabold text-stone-700">{totalUnits}</p>
                            </div>
                        </div>
                        <div className="mt-4 flex justify-between text-center divide-x divide-stone-100">
                            <div className="flex-1">
                                <div className="text-lg font-bold text-teal-600">{stats.active}</div>
                                <div className="text-[10px] uppercase font-bold text-stone-400">Active</div>
                            </div>
                            <div className="flex-1">
                                <div className="text-lg font-bold text-blue-400">{stats.dormant}</div>
                                <div className="text-[10px] uppercase font-bold text-stone-400">Dormant</div>
                            </div>
                            <div className="flex-1">
                                <div className="text-lg font-bold text-stone-400">{stats.never}</div>
                                <div className="text-[10px] uppercase font-bold text-stone-400">No Record</div>
                            </div>
                        </div>
                    </div>

                    {/* Visual Grid */}
                    <div className="glass-card p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-stone-700">Unit Status Map</h3>
                            <div className="relative w-24">
                                <select value={block} onChange={e=>setBlock(e.target.value)} className="modern-input py-2 h-10 text-sm appearance-none pr-8">
                                    {Object.keys(SUBDIVISION_MAP).sort((a,b)=>a-b).map(b=><option key={b} value={b}>Blk {b}</option>)}
                                </select>
                                <i className="fa-solid fa-chevron-down absolute right-3 top-3 text-stone-400 pointer-events-none text-xs"></i>
                            </div>
                        </div>

                        {loading ? <div className="text-center py-10 text-stone-300"><i className="fa-solid fa-circle-notch fa-spin text-2xl"></i></div> : (
                            <div className="grid grid-cols-5 gap-2">
                                {lots.map(n => {
                                    const status = statusMap[`${block}-${n}`];
                                    let cls = "bg-stone-100 text-stone-300"; // Default / Never
                                    
                                    if (status === "Active") {
                                        cls = "bg-teal-500 text-white shadow-md shadow-teal-200 font-bold";
                                    } else if (status === "Dormant") {
                                        cls = "bg-stone-50 text-stone-400 border-2 border-blue-300 font-medium";
                                    }

                                    return (
                                        <div key={n} className={`aspect-square rounded-xl text-sm flex items-center justify-center transition-all ${cls}`}>
                                            {n}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        <div className="mt-4 flex gap-4 justify-center text-xs text-stone-500">
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-teal-500 rounded-full"></div> Active</div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-stone-50 border-2 border-blue-300 rounded-full"></div> Dormant</div>
                            <div className="flex items-center gap-1"><div className="w-3 h-3 bg-stone-100 rounded-full"></div> No Rec</div>
                        </div>
                    </div>
                </PageContainer>
            );
        };

        const TallyMode = ({ showToast }) => {
            const [block, setBlock] = React.useState("1");
            const [categories, setCategories] = React.useState(DEFAULT_CATEGORIES);
            const [cat, setCat] = React.useState("");
            const [amt, setAmt] = React.useState(500);
            const [date, setDate] = React.useState(toInputDate(new Date()));
            const [sel, setSel] = React.useState([]);
            const [existing, setExisting] = React.useState([]);
            const [editPay, setEditPay] = React.useState(null);
            const [lastTap, setLastTap] = React.useState({id:null, t:0});
            const [showCatModal, setShowCatModal] = React.useState(false);

            const lots = Array.from({length: SUBDIVISION_MAP[block]||20}, (_,i)=>i+1);

            // Fetch Configured Categories
            React.useEffect(() => {
                const unsub = onSnapshot(doc(db, "config", "categories"), (snap) => {
                    if(snap.exists() && snap.data().list) {
                        const list = snap.data().list;
                        setCategories(list);
                        if (!cat && list.length > 0) setCat(list[0]); // Set default if empty
                    } else {
                        setCat(DEFAULT_CATEGORIES[0]);
                    }
                });
                return () => unsub();
            }, []);

            // Ensure cat is set after categories load
            React.useEffect(() => {
               if (!cat && categories.length > 0) setCat(categories[0]);
            }, [categories]);

            React.useEffect(() => {
                const unsub = onSnapshot(query(collection(db,"payments"), where("block","==",block)), s => {
                    setExisting(s.docs.map(d=>({id:d.id,...d.data()})));
                });
                return () => unsub();
            }, [block]);

            React.useEffect(() => setSel([]), [block, cat, date]);

            const getPaid = () => {
                if(!cat) return [];
                const m = getMonthYear(new Date(date));
                return existing.filter(p => p.category===cat && getMonthYear(p.datePaid.toDate())===m);
            };
            const paid = getPaid();
            const paidIds = paid.map(p=>parseInt(p.lot));

            const tapLot = (n) => {
                const now = Date.now();
                if(paidIds.includes(n)) {
                    if(lastTap.id===n && now-lastTap.t<300) setEditPay(paid.find(p=>parseInt(p.lot)===n));
                    else { setLastTap({id:n, t:now}); showToast("Already Paid! Double tap to edit.", "warning"); }
                } else {
                    setSel(prev => prev.includes(n) ? prev.filter(x=>x!==n) : [...prev,n]);
                }
            };

            const save = async () => {
                if(!sel.length) return;
                const bId = Date.now().toString();
                try {
                    await Promise.all(sel.map(n => addDoc(collection(db,"payments"), {
                        block, lot:n.toString(), category:cat, amount:parseFloat(amt), status:"Paid", datePaid:Timestamp.fromDate(new Date(date)), batchId:bId
                    })));
                    showToast(`Saved ${sel.length} entries!`, "success");
                    setSel([]);
                } catch(e) { showToast(e.message, "error"); }
            };

            return (
                <PageContainer>
                    {showCatModal && <CategoryManagerModal onClose={()=>setShowCatModal(false)} showToast={showToast} />}
                    {editPay && <EditPaymentModal payment={editPay} onClose={()=>setEditPay(null)} showToast={showToast}/>}
                    
                    <div className="glass-card p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-stone-700">Batch Settings</h3>
                            <button onClick={()=>setShowCatModal(true)} className="text-stone-400 hover:text-teal-600 transition">
                                <i className="fa-solid fa-gear text-lg"></i>
                            </button>
                        </div>
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Block</label>
                                <div className="relative">
                                    <select value={block} onChange={e=>setBlock(e.target.value)} className="modern-input appearance-none">
                                        {Object.keys(SUBDIVISION_MAP).sort((a,b)=>a-b).map(b=><option key={b} value={b}>{b}</option>)}
                                    </select>
                                    <i className="fa-solid fa-chevron-down absolute right-4 top-4 text-stone-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Date</label>
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="modern-input" />
                            </div>
                        </div>
                        <div className="space-y-3">
                            <div>
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Category</label>
                                <div className="relative">
                                    <select value={cat} onChange={e=>setCat(e.target.value)} className="modern-input appearance-none">
                                        {categories.map((c,i) => <option key={i} value={c}>{c}</option>)}
                                    </select>
                                    <i className="fa-solid fa-chevron-down absolute right-4 top-4 text-stone-400 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Amount</label>
                                <input type="number" value={amt} onChange={e=>setAmt(e.target.value)} className="modern-input text-teal-600 font-bold" />
                            </div>
                        </div>
                    </div>

                    <div className="glass-card p-6">
                        <div className="flex justify-between items-end mb-4">
                            <h3 className="font-bold text-stone-700">Tap Lots</h3>
                            <span className={`text-xs font-bold px-2 py-1 rounded-md ${sel.length?'bg-teal-100 text-teal-700':'bg-stone-100 text-stone-400'}`}>{sel.length} Selected</span>
                        </div>
                        <div className="grid grid-cols-5 gap-2">
                            {lots.map(n => {
                                const isP = paidIds.includes(n);
                                const isS = sel.includes(n);
                                let cls = "bg-stone-100 text-stone-400 border border-transparent";
                                if(isP) cls = "bg-teal-50 text-teal-600 border-teal-100 shadow-sm font-extrabold";
                                if(isS) cls = "bg-teal-600 text-white shadow-lg shadow-teal-200 scale-105";
                                return <button key={n} onClick={()=>tapLot(n)} className={`aspect-square rounded-xl font-bold text-sm transition-all duration-200 ${cls}`}>{n}</button>
                            })}
                        </div>
                    </div>

                    <button onClick={save} disabled={!sel.length} className="w-full py-4 bg-stone-900 text-white rounded-2xl font-bold shadow-xl disabled:opacity-50 disabled:shadow-none transition transform active:scale-95 mt-6 mb-10">
                        Record {sel.length} Payments
                    </button>
                </PageContainer>
            );
        };

        const ViewerMode = () => {
            const [sb, setSb] = React.useState("");
            const [sl, setSl] = React.useState("");
            const [viewMonth, setViewMonth] = React.useState(toInputMonth(new Date()));
            const [pay, setPay] = React.useState([]);
            const [load, setLoad] = React.useState(true);

            React.useEffect(() => {
                const unsub = onSnapshot(collection(db,"payments"), s => {
                    // Fetch ALL payments, client-side sort/filter is fast enough for <10k records
                    setPay(s.docs.map(d=>({id:d.id,...d.data()})));
                    setLoad(false);
                });
                return () => unsub();
            }, []);

            // LOGIC: Filter and Sort
            let displayData = [...pay];
            const isSearching = sb || sl;

            if (isSearching) {
                // Search Mode: Ignore Month, Filter by Unit, Sort Date Desc
                if(sb) displayData = displayData.filter(p => p.block === sb);
                if(sl) displayData = displayData.filter(p => p.lot === sl);
                displayData.sort((a,b) => b.datePaid.seconds - a.datePaid.seconds);
            } else {
                // Default Mode: Filter by Month, Sort Block Asc -> Lot Asc
                displayData = displayData.filter(p => {
                    const d = p.datePaid.toDate();
                    const m = d.toISOString().slice(0, 7);
                    return m === viewMonth;
                });
                displayData.sort((a,b) => {
                    const bDiff = parseInt(a.block) - parseInt(b.block);
                    if (bDiff !== 0) return bDiff;
                    return parseInt(a.lot) - parseInt(b.lot);
                });
            }

            const grouped = displayData.reduce((a,c) => { (a[c.category]=a[c.category]||[]).push(c); return a; }, {});

            return (
                <PageContainer>
                    <div className="glass-card p-6">
                        <div className="flex justify-between items-center mb-1">
                            <h2 className="text-2xl font-bold text-stone-800">Database</h2>
                            {!isSearching && (
                                <input type="month" value={viewMonth} onChange={e=>setViewMonth(e.target.value)} className="bg-stone-100 text-xs font-bold text-stone-600 rounded-lg px-2 py-1 border-none outline-none focus:ring-1 focus:ring-teal-500 h-8" />
                            )}
                        </div>
                        <p className="text-stone-400 text-sm mb-6">
                            {isSearching ? "Showing payment history" : "Showing records for selected month"}
                        </p>
                        <div className="flex gap-3">
                            <div className="flex-1">
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Block</label>
                                <input type="number" placeholder="#" value={sb} onChange={e=>setSb(e.target.value)} className="modern-input text-center text-lg" />
                            </div>
                            <div className="flex-1">
                                <label className="text-xs font-bold text-stone-400 ml-1 uppercase">Lot</label>
                                <input type="number" placeholder="#" value={sl} onChange={e=>setSl(e.target.value)} className="modern-input text-center text-lg" />
                            </div>
                        </div>
                    </div>

                    {load ? <div className="text-center py-10 text-stone-300"><i className="fa-solid fa-circle-notch fa-spin text-2xl"></i></div> :
                        Object.keys(grouped).length === 0 ? 
                        <div className="text-center py-12 opacity-50"><i className="fa-solid fa-folder-open text-4xl mb-2"></i><p>No records found</p></div> :
                        Object.keys(grouped).map(cat => (
                            <div key={cat} className="glass-card overflow-hidden animate-enter">
                                <div className="bg-stone-50/80 px-6 py-4 border-b border-stone-100 flex justify-between items-center">
                                    <h3 className="font-bold text-stone-700">{cat}</h3>
                                    <span className="text-xs font-bold bg-white border border-stone-200 px-2 py-1 rounded-lg text-stone-500">{grouped[cat].length}</span>
                                </div>
                                <div className="divide-y divide-stone-50">
                                    {grouped[cat].map(p => (
                                        <div key={p.id} className="p-4 px-6 flex justify-between items-center hover:bg-stone-50 transition">
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 rounded-xl bg-teal-50 text-teal-700 flex items-center justify-center font-bold text-xs border border-teal-100">
                                                    {p.block}-{p.lot}
                                                </div>
                                                <div>
                                                    <div className="text-xs text-stone-400 mb-0.5">{formatDateDisplay(p.datePaid.toDate())}</div>
                                                    <div className="font-bold text-stone-700">{formatMoney(p.amount)}</div>
                                                </div>
                                            </div>
                                            <i className="fa-solid fa-circle-check text-teal-500 text-lg"></i>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))
                    }
                </PageContainer>
            );
        };

        const SummaryMode = ({ user, showToast, scrollToTop }) => {
            const [pay, setPay] = React.useState([]);
            const [exp, setExp] = React.useState([]);
            const [initBal, setInitBal] = React.useState(null);
            const [showInit, setShowInit] = React.useState(false);
            const [load, setLoad] = React.useState(true);
            const [lastTap, setLastTap] = React.useState(0);

            // Expense Form
            const [eId, setEId] = React.useState(null);
            const [eTitle, setETitle] = React.useState("");
            const [eAmt, setEAmt] = React.useState("");
            const [eDate, setEDate] = React.useState(toInputDate(new Date()));

            React.useEffect(() => {
                const u1 = onSnapshot(collection(db,"payments"), s=>setPay(s.docs.map(d=>d.data())));
                const u2 = onSnapshot(query(collection(db,"expenses"), orderBy("date","desc")), s=>setExp(s.docs.map(d=>({id:d.id,...d.data()}))));
                getDoc(doc(db,"config","finance")).then(d => {
                    if(d.exists() && d.data().initialBalance!==undefined) setInitBal(d.data().initialBalance);
                    else if(user) setShowInit(true);
                    setLoad(false);
                }).catch(()=>setLoad(false));
                return () => { u1(); u2(); };
            }, [user]);

            const saveInit = async (v) => {
                await setDoc(doc(db,"config","finance"), {initialBalance:parseFloat(v)}, {merge:true});
                setInitBal(parseFloat(v)); setShowInit(false); showToast("Saved! Double tap header to edit.", "success");
            };

            const saveExp = async (e) => {
                e.preventDefault(); if(!user) return;
                const pl = { title:eTitle, amount:parseFloat(eAmt), date:Timestamp.fromDate(new Date(eDate)) };
                try {
                    if(eId) { await updateDoc(doc(db,"expenses",eId), pl); showToast("Expense Updated", "success"); }
                    else { await addDoc(collection(db,"expenses"), pl); showToast("Expense Added", "success"); }
                    setEId(null); setETitle(""); setEAmt("");
                } catch(err){ showToast(err.message, "error"); }
            };

            const headerTap = () => { if(user) { const n=Date.now(); if(n-lastTap<300) setShowInit(true); setLastTap(n); }};
            const editExp = (x) => { 
                setEId(x.id); 
                setETitle(x.title); 
                setEAmt(x.amount); 
                setEDate(toInputDate(x.date.toDate())); 
                scrollToTop(); 
            };

            // Logic
            const mData = {};
            pay.forEach(p => { const k=getMonthYear(p.datePaid.toDate()); if(!mData[k]) mData[k]={c:0,e:0,items:[]}; mData[k].c+=(p.amount||0); });
            exp.forEach(e => { const k=getMonthYear(e.date.toDate()); if(!mData[k]) mData[k]={c:0,e:0,items:[]}; mData[k].e+=(e.amount||0); mData[k].items.push(e); });
            
            const keys = Object.keys(mData).sort((a,b)=>new Date(a)-new Date(b)); 
            const sKeys = keys.sort((a,b) => Date.parse(`1 ${a}`) - Date.parse(`1 ${b}`));

            let run = initBal || 0;
            const report = sKeys.map(k => {
                const d = mData[k];
                const start = run;
                run += (d.c - d.e);
                return { label:k, start, end:run, ...d };
            }).reverse();

            return (
                <PageContainer>
                    <div onClick={headerTap} className="glass-card p-6 cursor-pointer select-none relative overflow-hidden group">
                        <div className="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition">
                            <i className="fa-solid fa-chart-pie text-6xl"></i>
                        </div>
                        <h2 className="text-2xl font-bold text-stone-800 mb-1">Financial Summary</h2>
                        <p className="text-stone-400 text-sm">Transparency Report</p>
                    </div>

                    {showInit && <InitBalModal initialBalance={initBal} onSave={saveInit} onClose={()=>setShowInit(false)} />}

                    {user && (
                        <div className="glass-card p-6 ring-1 ring-orange-100">
                            <h3 className="font-bold text-stone-700 mb-4 flex items-center gap-2">
                                <i className={`fa-solid ${eId?'fa-pen':'fa-plus'} text-orange-500`}></i> 
                                {eId ? 'Edit Expense' : 'Record Expense'}
                            </h3>
                            <form onSubmit={saveExp} className="space-y-3">
                                <input placeholder="Description (e.g. Repairs)" value={eTitle} onChange={e=>setETitle(e.target.value)} className="modern-input" required />
                                <div className="flex gap-3">
                                    <input type="number" placeholder="Amount" value={eAmt} onChange={e=>setEAmt(e.target.value)} className="modern-input" required />
                                    <input type="date" value={eDate} onChange={e=>setEDate(e.target.value)} className="modern-input" required />
                                </div>
                                <div className="flex gap-2 pt-1">
                                    {eId && <button type="button" onClick={()=>{setEId(null);setETitle("");setEAmt("")}} className="px-4 text-stone-400 font-bold">Cancel</button>}
                                    <button type="submit" className="flex-1 py-3 bg-stone-900 text-white rounded-xl font-bold hover:bg-stone-800 transition">{eId?'Update':'Add Entry'}</button>
                                </div>
                            </form>
                        </div>
                    )}

                    {load ? <div className="text-center py-10 text-stone-300"><i className="fa-solid fa-circle-notch fa-spin text-2xl"></i></div> :
                        report.map(r => (
                            <div key={r.label} className="glass-card overflow-hidden animate-enter">
                                <div className="bg-stone-50/80 px-6 py-4 border-b border-stone-100 flex justify-between items-center">
                                    <h3 className="font-bold text-stone-700">{r.label}</h3>
                                    <span className={`text-xs font-bold px-2 py-1 rounded-lg border ${r.end>=0?'bg-teal-50 text-teal-700 border-teal-100':'bg-red-50 text-red-700 border-red-100'}`}>
                                        Funds: {formatMoney(r.end)}
                                    </span>
                                </div>
                                <div className="p-6">
                                    <div className="bg-stone-50 rounded-xl p-3 flex justify-between items-center mb-4 border border-stone-100">
                                        <span className="text-xs font-bold text-stone-400 uppercase">Previous</span>
                                        <span className="font-bold text-stone-600">{formatMoney(r.start)}</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div className="p-3 rounded-2xl bg-teal-50/50 border border-teal-50">
                                            <div className="text-xs font-bold text-teal-400 uppercase mb-1">In</div>
                                            <div className="font-bold text-stone-700">{formatMoney(r.c)}</div>
                                        </div>
                                        <div className="p-3 rounded-2xl bg-red-50/50 border border-red-50">
                                            <div className="text-xs font-bold text-red-400 uppercase mb-1">Out</div>
                                            <div className="font-bold text-stone-700">{formatMoney(r.e)}</div>
                                        </div>
                                    </div>
                                    {r.items.length > 0 && (
                                        <div className="mt-6 border-t border-stone-100 pt-4">
                                            <p className="text-xs font-bold text-stone-400 uppercase mb-3">Expenses</p>
                                            <div className="space-y-3">
                                                {r.items.map(i => (
                                                    <div key={i.id} className="flex justify-between text-sm group">
                                                        <div className="flex items-center gap-2">
                                                            {user && <button onClick={()=>editExp(i)}><i className="fa-solid fa-pencil text-stone-300 hover:text-orange-500"></i></button>}
                                                            <span className="font-medium text-stone-600">{i.title}</span>
                                                            <span className="text-xs text-stone-400 bg-stone-100 px-1 rounded">{formatDateDisplay(i.date.toDate())}</span>
                                                        </div>
                                                        <span className="font-bold text-stone-700">{formatMoney(i.amount)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))
                    }
                </PageContainer>
            );
        };

        // --- APP SHELL ---

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('home');
            const [modal, setModal] = React.useState(false);
            const [toast, setToast] = React.useState(null);
            const scrollRef = React.useRef(null);

            React.useEffect(() => onAuthStateChanged(auth, setUser), []);

            const scrollToTop = () => scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' });

            const NavBtn = ({ id, icon, label }) => (
                <button 
                    onClick={() => setView(id)} 
                    className={`flex-1 flex flex-col items-center justify-center py-2 transition-all duration-300 ${view===id ? 'text-teal-600' : 'text-stone-400 hover:text-stone-600'}`}
                >
                    <div className={`text-xl mb-1 transition-transform ${view===id?'scale-110':''}`}><i className={`fa-solid ${icon}`}></i></div>
                    <span className="text-[10px] font-bold tracking-wide">{label}</span>
                </button>
            );

            return (
                <div className="fixed inset-0 flex flex-col bg-stone-50 overflow-hidden">
                    {/* 1. HEADER (Fixed in Flex) */}
                    <header className="bg-white border-b border-stone-200 px-6 py-4 flex justify-between items-center z-20 shrink-0 h-[72px]">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-tr from-teal-600 to-emerald-400 rounded-xl flex items-center justify-center text-white shadow-lg shadow-teal-100">
                                <i className="fa-solid fa-cube text-lg"></i>
                            </div>
                            <h1 className="font-extrabold text-xl tracking-tight text-stone-800">BlockSync</h1>
                        </div>
                        {user ? (
                            <button onClick={()=>signOut(auth)} className="w-10 h-10 bg-stone-100 rounded-full text-stone-400 hover:bg-red-50 hover:text-red-500 transition"><i className="fa-solid fa-power-off"></i></button>
                        ) : (
                            <button onClick={()=>setModal(true)} className="w-10 h-10 bg-stone-100 rounded-full text-stone-400 hover:bg-stone-200 transition"><i className="fa-solid fa-user-lock"></i></button>
                        )}
                    </header>

                    {/* 2. SCROLLABLE CONTENT (Takes remaining space) */}
                    <main ref={scrollRef} className="flex-1 overflow-y-auto scroll-area p-4 pb-0 relative">
                        <div className="pt-4">
                            {view === 'home' && <ViewerMode />}
                            {view === 'tally' && (user ? <TallyMode showToast={(m,t)=>setToast({m,t})} /> : <div className="text-center p-20 text-stone-400 font-bold">Admin Only</div>)}
                            {view === 'active' && (user ? <ActiveUnitsMode /> : <div className="text-center p-20 text-stone-400 font-bold">Admin Only</div>)}
                            {view === 'summary' && <SummaryMode user={user} showToast={(m,t)=>setToast({m,t})} scrollToTop={scrollToTop} />}
                        </div>
                    </main>

                    {/* 3. BOTTOM NAV (Replaces Burger) */}
                    <nav className="bg-white border-t border-stone-200 pb-[env(safe-area-inset-bottom)] z-30 shrink-0">
                        <div className="flex justify-around max-w-lg mx-auto py-2">
                            <NavBtn id="home" icon="fa-database" label="Data" />
                            {user && <NavBtn id="tally" icon="fa-list-check" label="Tally" />}
                            {user && <NavBtn id="active" icon="fa-map-location-dot" label="Status" />}
                            <NavBtn id="summary" icon="fa-chart-pie" label="Finance" />
                        </div>
                    </nav>

                    {modal && <LoginModal onClose={()=>setModal(false)} />}
                    {toast && <Toast message={toast.m} type={toast.t} onClose={()=>setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>